<html lang="en">
<head>

  
  <meta charset="utf-8">
  <title>Coletando logs do Check Point usando fw1-loggrabber</title>
  <meta name="description" content="Coletando logs do Check Point usando fw1-loggrabber">
  <meta name="author" content="Gama">

  
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link href="//fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="localhost:1313css/fonts.css">
  
  
  <link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.6.0/pure-min.css">
  

    <link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.6.0/grids-responsive-min.css">

  <link rel="stylesheet" href="localhost:1313css/custom.css">

  
  
  <link rel="stylesheet" href="localhost:1313highlight/styles/sunburst.css">
  
  <script src="localhost:1313highlight/highlight.pack.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>

</head>
<body>


<div class="header pure-g">
    <div class="pure-u-1-24 pure-u-md-5-24"></div>
    <div class="pure-u-11-12 pure-u-md-5-8">
        <div class="desktop pure-menu pure-menu-horizontal nav-menu">
            
            <a href="localhost:1313/" class="site-title pure-menu-heading">Security of Things</a>
            <ul class="pure-menu-list">
                
                <li class="pure-menu-item">
                    <a href="localhost:1313categories/english" class="pure-menu-link">English</a>
                </li>
                
                <li class="pure-menu-item">
                    <a href="localhost:1313categories/portugues" class="pure-menu-link">Portugues</a>
                </li>
                
                <li class="pure-menu-item">
                    <a href="localhost:1313about/" class="pure-menu-link">About</a>
                </li>
            </ul>
        </div>
        <div class="mobile pure-menu nav-menu">
            <a href="localhost:1313/" class="pure-menu-heading" id="toggle-home">Security of Things</a>
            <a href="#" id="toggle-btn">&#9776;</a>
            <ul class="pure-menu-list" id="toggle-content" style="display:none;">
                
                
                <li class="pure-menu-item">
                    <a href="localhost:1313categories/english" class="pure-menu-link">English</a>
                </li>
                
                <li class="pure-menu-item">
                    <a href="localhost:1313categories/portugues" class="pure-menu-link">Portugues</a>
                </li>
                
                <li class="pure-menu-item">
                    <a href="localhost:1313about" class="pure-menu-link">About</a>
                </li>
            </ul>
        </div>
    </div>
    <div class="pure-u-1-24 pure-u-md-1-6"></div>
</div>


<div class="pure-g">
    <div class="pure-u-1-24 pure-u-md-5-24"></div>
	<div class="pure-u-11-12 pure-u-md-5-8">
        <div class="post">

            <div class="post-title">
                <p class="footnote">
                    <time class="">2016-03-05</time>
		            
                    
                    |
                    
                    
                    tags:<a href="localhost:1313tags/Check-Point">Check Point</a> 
                    

                    
                    categories:<a href="localhost:1313categories/Portugues">Portugues</a> 
                    

                    
                </p>
                <h1>Coletando logs do Check Point usando fw1-loggrabber</h1>
            </div>

            <div class="post-content">
                

<h2 id="tl-dr:3780de4ec6e539fd9e79f53f296c60bf">TL;DR</h2>

<p>Coletar logs de firewalls Check Point é complicado. Nesse post, eu descrevo como consegui usar a ferramenta fw1-loggrabber rodando em um servidor Linux 32bit, capturar os logs de um Check Point Gaia R77.30, armazená-los em um arquivo e usar o logrotate para gerenciá-los.</p>

<h2 id="intro:3780de4ec6e539fd9e79f53f296c60bf">Intro</h2>

<p>Check Point é um produto sensacional. Até que se queira coletar logs dele com uma ferramenta externa. No meu caso, eu preciso coletar seus logs para um servidor Linux para que eu possa fazer umas coisas legais com eles. <a href="https://www.fir3net.com/Firewalls/Check-Point/a-quick-guide-to-checkpoints-opsec-lea.html">Existem</a> <a href="https://supportcenter.checkpoint.com/supportcenter/portal?eventSubmit_doGoviewsolutiondetails=&amp;solutionid=sk32521">vários</a> <a href="https://blog.rootshell.be/2014/08/28/check-point-firewall-logs-and-logstash-elk-integration/">métodos</a> <a href="http://www-01.ibm.com/support/knowledgecenter/SSSN2Y_1.0.0/com.ibm.itcim.doc/tcim85_install190.html%23opconz">disponíveis</a> em como fazer isso. Boa sorte com todos esses. Nenhum desses me ajudou a fazer o que eu fiz aqui nesse post. Por isso que é importante entender que esse guia usa o Check Point Gaia R77.30. O hardware pode ser qualquer coisa desde uma VM para um appliance. É possível que isso funcione em outros ambientes e outras versão. Ou não.</p>

<p>Para coletar logs do Check Point, o fw1-loggrabber será usado. Ele está <a href="https://github.com/certego/fw1-loggrabber">disponível aqui</a>. Pode-se também usar a versão <a href="http://sourceforge.net/projects/fw1-loggrabber/">disponível no sourceforge</a> mas esse código é antigo. Pode-se ver o trabalho feito no código da versão do github. Essa ferramenta só roda em Linux x86 This tool only runs on Linux x86 running kernel 3.16, so a Linux Ubuntu x86 was installed in the Lab Server running at 172.16.1.10 com kernel 3.16. Ele também roda com kernel 4. A confiança (trust) do OPSEC LEA tem que ser configurado entre a ferramenta e o Check Point. A compilação do código do fw1-loggrabber não vai funcionar se todas as dependências do Linux estiverem satisfeitas.</p>

<p>Esse guia assume que o laboratório já está preparado com:</p>

<ol>
<li>Um Check Point Gaia R77.30 com função Gateway and Management. No meu caso, é uma VM rodando os dois. O endereço IP é 172.16.1.1.</li>
<li>Um cliente Windows 7 para rodar o Check Point SmartDashboard. O endereço IP é 172.16.1.11.</li>
<li>Um servidor Linux x86 rodando kernel 3.16 para hospedar o fw1-loggrabber. O endereço IP é  172.16.1.10.</li>
</ol>

<p>O processo de criação do laboratório é por sua conta. Se você quiser mais informação, me mande uma mensagem.</p>

<h2 id="configurando-o-check-point:3780de4ec6e539fd9e79f53f296c60bf">Configurando o Check Point</h2>

<p>Primeiramente, é preciso configurar a Manager do Check Point para aceitar a conexão OPSEC LEA. Isso pode ser feito assim:</p>

<ol>
<li><p>Conecte-se ao SmartDashboard como admin</p></li>

<li><p>Crie um objeto Host para o servidor Linux que vai coletar os logs:<br />

<figure >
    
        <img src="localhost:1313/img/01.png" />
    
    
</figure>

O servidor Linux é 172.16.1.10:<br />

<figure >
    
        <img src="localhost:1313/img/02.png" />
    
    
</figure>
</p></li>

<li><p>Crie o objeto OPSEC:</p>

<ul>
<li>Vá no &ldquo;Servers and OPSEC&rdquo; e clique com o botão direito no diretório &ldquo;OPSEC Application&rdquo;. Crie um &ldquo;New OPSEC Application&rdquo;:<br />

<figure >
    
        <img src="localhost:1313/img/03.png" />
    
    
</figure>
</li>
<li>Configure o objeto OPSEC. Dê um nome, selecione o Host que foi acabado de ser criado para o servidor Linux e selecione a opção LEA:<br />

<figure >
    
        <img src="localhost:1313/img/04.png" />
    
    
</figure>
<br /></li>
<li>Clique em Communication e crie uma nova senha SIC. Note que quando isso for feito, o acesso já estará disponível, sem a necessidade de se instalar a política no firewall:<br />

<figure >
    
        <img src="localhost:1313/img/05.png" />
    
    
</figure>
<br /></li>
</ul></li>

<li><p>Talvez seja necessário adicionar uma regra de firewall para permitir a conexão OPSEC LEA entre o servidor Linux e a Manager Check Point usando porta TCP/18184 (FW1_lea)</p>

<ul>
<li>De 172.16.1.10 para 172.16.1.1 na porta TCP/18184</li>
</ul></li>
</ol>

<h2 id="configurando-o-linux:3780de4ec6e539fd9e79f53f296c60bf">Configurando o Linux</h2>

<p>Eu estou usando um Debian 8.2 no laboratório:

<figure >
    
        <img src="localhost:1313/img/06.png" />
    
    
</figure>
<br />
A ferramenta fw1-loggrabber precisa ser compilada do código fonte. Vamos usar o usuário <code>user</code> e o diretório de trabalho <code>/home/user/fw1-loggrabber</code>.</p>

<ol>
<li><p>Antes de começar, as seguintes dependências precisam ser instaladas. Isso irá provavelmente instalar mais inúmeros pacotes, mas isso vai depender de qual Linux você está usando:</p>

<pre><code>user@debian:~$ apt-get install git gcc-multilib g++-multilib libelf-dev:i386
</code></pre></li>

<li><p>Faça o download da ferramenta:</p>

<pre><code>user@debian:~$ mkdir fw1-loggrabber; cd fw1-loggrabber
user@debian:~/fw1-loggrabber$ git clone https://github.com/certego/fw1-loggrabber
</code></pre>

<p>Isso fará com que o código-fonte do fw1-loggrabber seja armazenado em <code>/home/user/fw1-loggrabber/fw1-loggrabber</code>. Quando tudo estiver pronto, esse diretório poderá ser removido.</p></li>

<li><p>Baixe as bibliotecas de desenvolvimento necessários do OPSEC <a href="supportcontent.checkpoint.com/file_download?id=7385">do site da Check Point aqui</a>. Copie o arquivo <code>OPSEC_SDK_6.0_Linux.zip</code> para o diretório <code>/home/user/fw1-loggrabber</code> e o descompresse. Isso é necessário para compilação do fw1-loggrabber.</p>

<pre><code>user@debian:~/fw1-loggrabber$ unzip OPSEC_SDK_6.0_Linux.zip
</code></pre>

<p>Esse arquivo zip contém o SDK linux no arquivo <code>OPSEC_SDK_6_0.linux30.tar.gz</code>. Esse arquivo precisa ser descomprimido no mesmo diretório do fw1-loggrabber com o seguinte comando:</p>

<pre><code>user@debian:~/fw1-loggrabber$ tar zxvf OPSEC_SDK_6_0.linux30.tar.gz
</code></pre>

<p>Os arquivos serão extraídos no diretório <code>pkg_rel</code>.</p></li>

<li><p>Compile o fw1-loggrabber. Mas primeiro, vá em <code>/home/user/fw1-loggrabber/fw1-loggrabber</code> e troque a seguinte linha no arquivo <code>Makefile</code> de acordo com esse modelo:</p>

<pre><code>PKG_DIR = ../pkg_rel
</code></pre>

<p>Então finalmente compile o código e o instale para que seja possível utilizá-lo posteriormente:</p>

<pre><code>user@debian:~/fw1-loggrabber/fw1-loggrabber$ make
</code></pre>


<figure >
    
        <img src="localhost:1313/img/07.png" />
    
    
</figure>


<pre><code>user@debian:~/fw1-loggrabber/fw1-loggrabber$ sudo make install
</code></pre>

<p>
<figure >
    
        <img src="localhost:1313/img/08.png" />
    
    
</figure>
<br />
O fw1-loggrabber será instalado em <code>/usr/local/fw1-loggrabber/</code>. Quando isso estiver feito, tudo dentro do diretório <code>/home/user/fw1-loggrabber/</code> poderá ser removido com o seguinte comando:</p>

<pre><code>user@debian:~/fw1-loggrabber/fw1-loggrabber$ cd
user@debian:~$ rm -rf fw1-loggrabber/*
</code></pre></li>

<li><p>Faça o download do opsec-tools <a href="http://sourceforge.net/projects/fw1-loggrabber/files/opsec-tools/NG-FP3/">desse link</a>. Essa ferramenta irá integrar o servidor Linux com a Manager Check Point através do canal OPSEC e a senha SIC. A ferramenta já é compilada para Linux 32bit. Copie o arquivo <code>opsec-tools.tar.gz</code> para o diretório <code>/home/user/</code> e o descomprima. Essa ferramenta poderá ser usada novamente depois, se necessário.</p>

<pre><code>user@debian:~/$ tar zxvf opsec-tools.tar.gz
</code></pre></li>

<li><p>Integre o servidor Linux com a Manager Check Point via OPSEC através do comando opsec-tool. Isso gerará uma conexão TCP entre o servidor Linux e a Manager Check Point na porta TCP/18210 (FW1-ica-pull). Para rodar o comando, as seguintes informações são necessárias:</p>

<ul>
<li>O endereço IP da Manager Check Point = 172.16.1.1. Isso vai na opção <code>-h</code></li>
<li>O objecto OPSEC que foi criado = LogGrabberOPSEC. Isso vai na opção <code>-n</code></li>
<li>A senha que foi configurada para a comunicação (SIC). Isso vai na opção <code>-p</code><br /></li>
</ul>

<pre><code>user@debian:~$ cd opsec-tools/linux22
user@debian:~/opsec-tools/linux22$ opsec_pull_cert -h 172.16.1.1 -n LogGrabberOPSEC -p &lt;PASSWD&gt;
</code></pre>

<p>O resultado na shell:<br />

<figure >
    
        <img src="localhost:1313/img/09.png" />
    
    
</figure>
</p>

<p>A saída desse comando nos dá duas informações fundamentais para a integração OPSEC:</p>

<ul>
<li>O arquivo opsec.p12: é o certificato usado para a comunicação entre os dois servidores</li>
<li>O Common Name (CN) do certificado, que é necessário para o fw1-loggrabber. Nesse caso, ele é <code>CN=LogGrabberOPSEC,O=gw..n7symj</code>. Agora temos tudo o que se precisa para rodas a ferramenta fw1-loggrabber.</li>
</ul></li>

<li><p>Copie o arquivo <code>opsec.p12</code> para o diretório de trabalho do fw1-loggrabber:</p>

<pre><code>user@debian:~/opsec-tools/linux22$ cp opsec.p12 /home/user/fw1-loggrabber
</code></pre></li>

<li><p>Configure o arquivo de configuração LEA. Primeiro, copie o arquivo modelo do diretório:</p>

<pre><code>user@debian:~$ cp /usr/local/fw1-loggrabber/etc/lea.conf-sample /home/user/fw1-loggrabber/lea.conf
</code></pre>

<p>Troque os parâmetros nesse arquivo lea.conf de acordo com o que adquirimos anteriormente:</p>

<ul>
<li><code>lea_server ip</code> é o endereço IP da Manager Check Point: 172.16.1.1</li>
<li><code>opsec_sic_name</code> é o CN do certificado que foi capturado pela ferramenta opsec-tool: <code>CN=LogGrabberOPSEC,O=gw..n7symj</code></li>
<li><code>opsec_sslca_file</code> é o caminho do diretório até o arquivo opsec.p12 capturado pelo opsec-tool: <code>/home/user/fw1-loggrabber/opsec.p12</code></li>
<li><code>lea_server opsec_entity_sic_name</code> é o Distinguished Name (DN) do certificado da Manager Check Point Manager. Essa informação pode ser coletada pelo Check Point SmartDashboard e editando o objecto da Manager do Check Point e clicando-se no botão Test SIC Status:<br />

<figure >
    
        <img src="localhost:1313/img/10.png" />
    
    
</figure>
<br />
O DN pode ser encontrado no campo em evidência abaixo:<br />

<figure >
    
        <img src="localhost:1313/img/11.png" />
    
    
</figure>
<br />
Nesse caso, ele é <code>cn=cp_mgmt,o=gw..n7symj</code>. Finalmente, o arquivo de configuração lea.conf tem o seguinte conteúdo:<br /></li>
</ul>

<pre><code>lea_server auth_type sslca
lea_server ip 172.16.1.1
lea_server auth_port 18184
opsec_sic_name &quot;CN=LogGrabberOPSEC,O=gw..n7symj&quot;
opsec_sslca_file /home/user/fw1-loggrabber/opsec.p12
lea_server opsec_entity_sic_name &quot;cn=cp_mgmt,o=gw..n7symj&quot;
</code></pre></li>

<li><p>É hora de se configurar o fw1-loggrabber e fornecer os parâmetros do OPSEC LEA. Para simplicidade, eu usei a configuração padrão do fw1-loggrabber disponível em <code>/usr/local/fw1-loggrabber/etc/</code>. Copie esse arquivo para o diretório de trabalho:</p>

<pre><code>user@debian:~$ cp /usr/local/fw1-loggrabber/etc/fw1-loggrabber.conf-sample /home/user/fw1-loggrabber/fw1-loggrabber.conf
</code></pre>

<p>Eu troquei algumas coisas no arquivo padrão, mas a documentação desses parâmetros está bem descrita em sua página <a href="https://github.com/certego/fw1-loggrabber">do repositório github</a>. As seguintes linhas estão no arquivo de configuração que eu uso:</p>

<pre><code>DEBUG_LEVEL=&quot;0&quot;
FW1_LOGFILE=&quot;fw.log&quot;
FW1_OUTPUT=&quot;logs&quot;
FW1_TYPE=&quot;ng&quot;
FW1_MODE=&quot;normal&quot;
ONLINE_MODE=&quot;yes&quot;
RESOLVE_MODE=&quot;no&quot;
RECORD_SEPARATOR=&quot;|&quot;
DATEFORMAT=&quot;std&quot;
LOGGING_CONFIGURATION=file
OUTPUT_FILE_PREFIX=&quot;fw1-loggrabber&quot;
OUTPUT_FILE_ROTATESIZE=1048576
SYSLOG_FACILITY=&quot;LOCAL1&quot;
</code></pre></li>

<li><p>Rode a ferramenta. Note que com esse arquivo de configuração, o arquivo de saída será salvo em <code>fw1-lograbber.conf</code>. Se a ferramenta rodar corretamente, os logs serão coletados da Manager Check Point indefinidamente. Faça um favor a si mesmo e coloque o fw1-loggrabber na sua variável de ambiente PATH:</p>

<pre><code>user@debian:~/fw1-loggrabber$ /usr/local/fw1-loggrabber/bin/fw1-loggrabber -c fw1-loggrabber.conf -l lea.conf
</code></pre></li>
</ol>

<h2 id="extras:3780de4ec6e539fd9e79f53f296c60bf">Extras</h2>

<h3 id="volume-de-logs:3780de4ec6e539fd9e79f53f296c60bf">Volume de Logs</h3>

<p>Dependendo da sua instalação de Check Point, o volume de logs capturado pode ser gigante. Eu não gostaria de lidar com arquivos de múltiplos gigabytes de tamanho. Então eu usei o logrotate para fazer o trabalho sujo pra mim:</p>

<pre><code>/home/user/fw1-loggrabber/fw1-loggrabber.log{
   size 100M
   compress
   compresscmd /usr/bin/xz
   compressext .xz
   rotate 1
   copytruncate
   nocreate
   su user user
   missingok
   notifempty
}
</code></pre>

<p>Com a diretida <code>lastaction</code> do logrotate, consegue-se fazer coisas legais com o arquivo, tipo copiando para um outro diretório de backup offline ou qualquer outra coisa, do tipo enviar para um AWS bucket.</p>

<h3 id="parâmetros-de-configuração-extra:3780de4ec6e539fd9e79f53f296c60bf">Parâmetros de Configuração Extra</h3>

<p>Você vai perceber rapidamente que o arquivo de log está poluído com informações repetitivas e irrelevantes. Eu adicionei as seguintes linhas de configuração no fw1-loggrabber.conf para remover alguns campos inúteis. Note que esses campos não são documentados em lugar nenhum. Por favor, deixe-me saber se eles são.</p>

<pre><code>IGNORE_FIELDS=i/f_dir;i/f_name;has_accounting;uuid;product;__policy_id_tag;origin_sic_name;rule_uid;app_desc;app_id;app_category;matched_category;app_properties;app_rule_id;app_rule_name;app_sig_id;UserCheck_incident_uid
</code></pre>

<p>Eu tentei usar a opção FW1_FILTER_RULE no arquivo de configuração, mas ela é tão limitada e cheia de problemas que eu desisti.</p>

            </div>
        </div>
	</div>
    <div class="pure-u-1-24 pure-u-md-1-6"></div>
</div>

<div class="footer pure-g">
    <div class="pure-u-1-24 pure-u-md-5-24"></div>
    <div class="pure-u-11-12 pure-u-md-5-8">
        <div class="pure-menu pure-menu-horizontal footer-content">
            <ul>
                <li class="pure-menu-heading" id="foot-name">Gama:</li>

                

                
                <li class="pure-menu-item">
                    <a href="https://github.com/gammenion" class="pure-menu-link">GitHub</a>
                </li>
                

                

                

                
                <li class="pure-menu-item">
                    <a href="https://twitter.com/gammenion" class="pure-menu-link">Twitter</a>
                </li>
                

            </ul>
            <a href="#" class="pure-menu-heading pull-right" id="gototop-btn">↑↑</a>
        </div>
	  </div>
      <div class="pure-u-1-24 pure-u-md-1-6"></div>
</div>


<script src="localhost:1313js/jquery.min.js" type="text/javascript"></script>
<script src="localhost:1313js/jquery.timeago.js" type="text/javascript"></script>
<script type="text/javascript">
  $(function(){
    $("time.timeago").timeago();
  })
  $("#toggle-btn").click(function(){
    $("#toggle-content").toggle();
    if($(this).html() === "☰") {
        $(this).html("X")
    } else {
        $(this).html("☰")
    }
  });
  $(window).resize(function(){
    if(window.innerWidth > 768) {
      $(".desktop").removeAttr("style");
    }
  });
</script>

</body>
</html>

